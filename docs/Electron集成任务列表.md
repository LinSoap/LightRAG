# Electron集成任务列表

## 任务概览
基于解决方案，优先解决影响最大的4个核心问题。

## ✅ 任务1：动态端口管理（已完成）
### 问题
- 端口固定9621，容易冲突
- 无法多实例运行
- 网络暴露安全风险

### 目标
- 实现动态端口分配
- 支持命令行参数配置
- 绑定本地访问

### ✅ 已完成
- [x] 修改main.py添加端口检测逻辑
- [x] 实现find_free_port函数
- [x] 添加命令行参数支持(--port, --host, --reload, --log-level)
- [x] 修改绑定地址为127.0.0.1
- [x] 添加启动信息显示
- [x] 实现端口自动选择功能

### 验证结果
- [x] 帮助信息正常显示
- [x] 自动端口选择功能正常
- [x] 指定端口功能正常
- [x] 脚本入口配置正确

## 🔴 任务2：进程生命周期管理
### 问题
- 缺乏优雅关闭机制
- 可能产生僵尸进程
- 资源泄漏风险

### 目标
- 实现优雅关闭
- 添加信号处理
- 资源清理机制

### 交付物
- [ ] 创建ServiceManager类
- [ ] 实现信号处理器(SIGINT, SIGTERM)
- [ ] 添加atexit清理函数
- [ ] 进程状态管理
- [ ] 状态保存和恢复
- [ ] 优雅关闭测试

## 🔴 任务3：健康检查机制
### 问题
- 缺乏服务状态监控
- 无法及时发现异常
- 用户无感知故障

### 目标
- 添加健康检查端点
- 组件状态监控
- 资源使用监控

### 交付物
- [ ] 实现health_check端点
- [ ] 存储组件状态检查
- [ ] 内存使用监控
- [ ] 活跃任务计数
- [ ] 状态信息格式化
- [ ] 健康检查端点测试

## 🔴 任务4：存储路径配置化
### 问题
- 存储路径硬编码
- 多用户数据混乱
- 跨平台路径不一致

### 目标
- 实现跨平台路径管理
- 支持用户自定义位置
- 多用户数据隔离

### 交付物
- [ ] 实现get_default_storage_dir
- [ ] 跨平台路径适配(Windows/macOS/Linux)
- [ ] 配置文件支持
- [ ] 数据迁移功能
- [ ] 工作目录管理
- [ ] 存储路径测试

## 📋 后续任务建议

### 任务5：配置文件管理（可选）
- 实现配置文件读写
- 支持YAML/JSON格式
- 配置热重载

### 任务6：服务发现机制（可选）
- 端口信息写入文件
- 服务注册与发现
- 多实例协调

### 任务7：日志系统优化（可选）
- 结构化日志输出
- 日志轮转机制
- 日志级别动态调整

## 当前进度
- **已完成任务**：2/4 ✅
- **进行中任务**：任务3（健康检查机制）
- **预估剩余时间**：1周

## ✅ 已完成任务详情

### 任务1：动态端口管理（已完成）
- ✅ 命令行参数支持(--port, --host, --reload, --log-level)
- ✅ 动态端口检测和分配
- ✅ 启动信息显示和帮助文档

### 任务2：进程生命周期管理（已完成）
- ✅ ServiceManager类实现完整生命周期管理
- ✅ 信号处理器(SIGINT, SIGTERM)支持优雅关闭
- ✅ atexit清理函数和资源管理
- ✅ 健康检查端点(/health)和服务信息端点(/service-info)
- ✅ 子进程、线程、任务统一管理
- ✅ 内存和CPU监控

## 🔴 任务3：健康检查机制（进行中）
### 问题
- 缺乏服务状态监控
- 无法及时发现异常
- 用户无感知故障

### 目标
- 添加健康检查端点 ✅（已完成）
- 组件状态监控
- 资源使用监控
- 告警机制

### 剩余交付物
- [x] 实现health_check端点（已集成到任务2）
- [ ] 存储组件状态检查
- [ ] LLM模型状态监控
- [ ] 向量数据库连接检查
- [ ] 活跃任务超时监控
- [ ] 健康检查端点集成测试

## 🔴 任务4：存储路径配置化
### 问题
- 存储路径硬编码
- 多用户数据混乱
- 跨平台路径不一致

### 目标
- 实现跨平台路径管理
- 支持用户自定义位置
- 多用户数据隔离

### 交付物
- [ ] 实现get_default_storage_dir
- [ ] 跨平台路径适配(Windows/macOS/Linux)
- [ ] 命令行参数支持(--storage-dir, --workspace)
- [ ] 配置文件支持
- [ ] 数据迁移功能
- [ ] 工作目录管理
- [ ] 存储路径测试

## 下一步行动
1. **立即开始**：任务3 - 健康检查机制（剩余部分）
2. **优先级**：任务3 → 任务4
3. **测试策略**：每个任务完成后立即测试验证

## 📋 任务3详细规划

### 3.1 存储组件状态检查
- 检查JSON文件存储访问权限
- 验证向量数据库连接状态
- 检查图数据库内存使用情况
- 验证文档状态存储完整性

### 3.2 LLM模型状态监控
- 检查LLM服务连接状态
- 监控API调用成功率
- 跟踪响应时间
- 检查token使用情况

### 3.3 资源使用告警
- 内存使用率告警（>80%）
- CPU使用率告警（>90%）
- 磁盘空间告警（<10%）
- 活跃任务数量告警

### 3.4 集成测试
- 模拟存储故障测试
- LLM服务中断测试
- 高负载场景测试
- 恢复能力测试

## 预估时间安排
- **任务3剩余部分**：2-3天
- **任务4**：3-4天
- **总体剩余时间**：1周

## 新增建议任务

### 任务5：配置文件管理（可选）
- YAML/JSON配置文件支持
- 配置热重载
- 环境变量覆盖

### 任务6：服务发现机制（可选）
- 端口信息写入文件
- 服务注册与发现
- 多实例协调

### 任务7：日志系统优化（可选）
- 结构化日志输出
- 日志轮转机制
- 日志级别动态调整

## 注意事项
1. 每个任务保持向后兼容
2. 代码风格保持一致
3. 添加适当的错误处理
4. 编写必要的注释
5. 更新相关文档
6. 测试覆盖所有功能点